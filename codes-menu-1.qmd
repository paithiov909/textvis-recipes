# ã‚³ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°ãƒ¡ãƒ‹ãƒ¥ãƒ¼

```{r}
#| label: setup
suppressPackageStartupMessages({
  library(ggplot2)
  library(ca)
  library(duckdb)
})
drv <- duckdb::duckdb()
con <- duckdb::dbConnect(drv, dbdir = "tutorial_jp/kokoro.duckdb", read_only = TRUE)

tbl <-
  readxl::read_xls("tutorial_jp/kokoro.xls",
    col_names = c("text", "section", "chapter", "label"),
    skip = 1
  ) |>
  dplyr::mutate(
    doc_id = factor(dplyr::row_number()),
    dplyr::across(where(is.character), ~ audubon::strj_normalize(.))
  ) |>
  dplyr::filter(!gibasa::is_blank(text)) |>
  dplyr::relocate(doc_id, text, section, label, chapter)
```

---

## å˜ç´”é›†è¨ˆï¼ˆA.7.1ï¼‰

```{r}
#| label: create-codes
rules <- list(
  "äººã®æ­»" = c("æ­»å¾Œ", "æ­»ç—…", "æ­»æœŸ", "æ­»å› ", "æ­»éª¸", "ç”Ÿæ­»", "è‡ªæ®º", "æ®‰æ­»", "é “æ­»", "å¤‰æ­»", "äº¡", "æ­»ã¬", "äº¡ããªã‚‹", "æ®ºã™", "äº¡ãã™", "æ­»"),
  "æ‹æ„›" = c("æ„›", "æ‹", "æ„›ã™", "æ„›æƒ…", "æ‹äºº", "æ„›äºº", "æ‹æ„›", "å¤±æ‹", "æ‹ã—ã„"),
  "å‹æƒ…" = c("å‹é”", "å‹äºº", "æ—§å‹", "è¦ªå‹", "æœ‹å‹", "å‹", "ç´šå‹"),
  "ä¿¡ç”¨ãƒ»ä¸ä¿¡" = c("ä¿¡ç”¨", "ä¿¡ã˜ã‚‹", "ä¿¡ãšã‚‹", "ä¸ä¿¡", "ç–‘ã„", "ç–‘æƒ‘", "ç–‘å¿µ", "çŒœç–‘", "ç‹ç–‘", "ç–‘å•", "ç–‘ã„æ·±ã„", "ç–‘ã†", "ç–‘ã‚‹", "è­¦æˆ’"),
  "ç—…æ°—" = c("åŒ»è€…", "ç—…äºº", "ç—…å®¤", "ç—…é™¢", "ç—…ç—‡", "ç—…çŠ¶", "æŒç—…", "æ­»ç—…", "ä¸»æ²»åŒ»", "ç²¾ç¥ç—…", "ä»®ç—…", "ç—…æ°—", "çœ‹ç—…", "å¤§ç—…", "ç—…ã‚€", "ç—…")
) |>
  quanteda::dictionary()

dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::mutate(token = dplyr::if_else(is.na(original), token, original)) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(doc_id, token, n) |>
  quanteda::dfm_lookup(rules)

dfm |>
  quanteda::convert(to = "data.frame") |>
  dplyr::mutate(`ã‚³ãƒ¼ãƒ‰ãªã—` = as.numeric(rowSums(dplyr::pick(where(is.numeric))) == 0)) |>
  tidyr::pivot_longer(cols = !doc_id, names_to = "code", values_to = "count") |>
  dplyr::summarise(
    total = sum(count),
    prop = total / dplyr::n(),
    .by = code
  )
```

## ã‚¯ãƒ­ã‚¹é›†è¨ˆï¼ˆA.7.2ï¼‰

### ã‚¯ãƒ­ã‚¹è¡¨

```{r}
#| label: count-codes
dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::mutate(token = dplyr::if_else(is.na(original), token, original)) |>
  dplyr::count(label, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(label, token, n) |>
  quanteda::dfm_lookup(rules)

dfm |>
  quanteda::convert(to = "data.frame") |>
  dplyr::mutate(`ã‚³ãƒ¼ãƒ‰ãªã—` = as.numeric(rowSums(dplyr::pick(where(is.numeric))) == 0)) |>
  tidyr::pivot_longer(cols = !doc_id, names_to = "code", values_to = "count") |>
  dplyr::left_join(
    dplyr::distinct(tbl, label, section),
    by = dplyr::join_by(doc_id == label)
  ) |>
  tidyr::uncount(count) |>
  crosstable::crosstable(section, by = code, total = "both") |>
  crosstable::as_flextable()
```

### ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—

æ¨ªã«é•·ã™ãã¦ãƒ©ãƒ™ãƒ«ãŒè¦‹ã¥ã‚‰ã„ã€‚

```{r}
#| label: plot-codes-heatmap
#| fig-width: 12
dfm |>
  quanteda::convert(to = "data.frame") |>
  dplyr::mutate(`ã‚³ãƒ¼ãƒ‰ãªã—` = as.numeric(rowSums(dplyr::pick(where(is.numeric))) == 0)) |>
  tidyr::pivot_longer(cols = !doc_id, names_to = "code", values_to = "count") |>
  dplyr::filter(count > 0) |>
  ggplot(aes(x = factor(doc_id, levels = unique(tbl$label)), y = code)) +
  geom_raster(aes(fill = count)) +
  labs(x = element_blank(), y = element_blank()) +
  theme_classic() +
  theme(axis.text.x = element_text(angle = 90, vjust = 1, hjust = 1))
```

### ãƒãƒ«ãƒ¼ãƒ³ãƒ—ãƒ­ãƒƒãƒˆ

```{r}
#| label: plot-codes-balloon
dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::mutate(token = dplyr::if_else(is.na(original), token, original)) |>
  dplyr::count(section, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(section, token, n) |>
  quanteda::dfm_lookup(rules)

dat <- dfm |>
  quanteda::convert(to = "data.frame") |>
  dplyr::mutate(`ã‚³ãƒ¼ãƒ‰ãªã—` = as.numeric(rowSums(dplyr::pick(where(is.numeric))) == 0)) |>
  tidyr::pivot_longer(cols = !doc_id, names_to = "code", values_to = "count")

clusters <- dat |>
  tidytext::cast_dfm(doc_id, code, count) |>
  proxyC::dist(margin = 2, method = "euclidean") |>
  as.dist() |>
  hclust(method = "ward.D2")

dat |>
  ggpubr::ggballoonplot(x = "doc_id", y = "code", size = "count", color = "gray", fill = "#f5f5f5", show.label = TRUE) +
  ggh4x::scale_y_dendrogram(hclust = clusters)
```

## é¡ä¼¼åº¦è¡Œåˆ—ï¼ˆA.7.3ï¼‰

```{r}
#| label: calc-simil
dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::mutate(token = dplyr::if_else(is.na(original), token, original)) |>
  dplyr::count(label, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(label, token, n) |>
  quanteda::dfm_lookup(rules) |>
  quanteda::dfm_weight(scheme = "boolean")

quanteda.textstats::textstat_simil(dfm, margin = "features", method = "jaccard")
```

## ãã®ä»–ã®åˆ†æï¼ˆA.7.4-8ï¼‰

åŸºæœ¬çš„ã«æŠ½å‡ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®ã¨ãã¨åŒã˜ã‚„ã‚Šæ–¹ã§ã‚°ãƒ©ãƒ•ã‚’ã¤ãã‚‹ã“ã¨ãŒã§ãã‚‹ã¯ãšã€‚éšå±¤çš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åˆ†æã€å…±èµ·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã€SOMã«ã¤ã„ã¦ã¯çœç•¥ã™ã‚‹ã€‚

### å¯¾å¿œåˆ†æ

```{r}
#| label: plot-ca
library(ca)

quanteda.textmodels::textmodel_ca(dfm, nd = 2, sparse = TRUE) |>
  plot()
```

### å¤šæ¬¡å…ƒå°ºåº¦æ§‹æˆæ³•ï¼ˆMDSï¼‰

```{r}
#| label: mds
#| cache: true
simil <- dfm |>
  proxyC::simil(margin = 2, method = "jaccard")

dat <- MASS::sammon(1 - simil, k = 2) |>
  purrr::pluck("points")
```

```{r}
#| label: plot-mds
dat <- dat |>
  dplyr::as_tibble(
    rownames = "label",
    .name_repair = ~ c("Dim1", "Dim2")
  ) |>
  dplyr::mutate(
    clust = (hclust(
      proxyC::dist(dat, method = "euclidean") |> as.dist(),
      method = "ward.D2"
    ) |> cutree(k = 3))[label]
  )

dat |>
  ggplot(aes(x = Dim1, y = Dim2, label = label, col = factor(clust))) +
  geom_point(alpha = .3, show.legend = FALSE) +
  ggrepel::geom_label_repel(show.legend = FALSE) +
  theme_classic()
```

### LSSğŸ³

æ¥µæ€§ã‚’ã‚ã‚‰ã‚ã™å°‘æ•°ã®ç¨®èªã‚’ä½¿ã„ã¤ã¤ã€æŒ‡å®šã—ãŸèªã¨å…±èµ·ã™ã‚‹èªã‚„æ–‡æ›¸ã«ã¤ã„ã¦1æ¬¡å…ƒã®æ¥µæ€§ã‚’ä¸ãˆã‚‹æ‰‹æ³•ã‚‰ã—ã„ã€‚[LSX](https://cran.r-project.org/package=LSX)ã¨ã„ã†ãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã¨ã—ã¦å®Ÿè£…ã•ã‚Œã¦ã„ã‚‹ã€‚

æœ¬æ¥ã¯`k`ï¼ˆTruncated SVDã«ãŠã‘ã‚‹ãƒ©ãƒ³ã‚¯ï¼‰ã¯200ï½300ç¨‹åº¦ã‚’æŒ‡å®šã™ã‚‹ãŸã‚ã€ç›¸å½“ã®é‡ã®æ–‡æ›¸ãŒå¿…è¦ã€‚ææ¡ˆè«–æ–‡ã§ã¯ã€ãŠãŠã‚€ã­40æ–‡ç¨‹åº¦ã®é•·ã•ã®æ–‡æ›¸ãŒ5,000ï½10,000æ–‡æ›¸ãã‚‰ã„å¿…è¦ã¨æ›¸ã‹ã‚Œã¦ã„ã‚‹ã€‚ã“ã“ã§ã¯åˆ†æã«ã‹ã‘ã‚‹æ–‡æ›¸ãŒè¶³ã‚Šã¦ã„ãªã„ã®ã§ã€æ„å‘³ã‚’è§£é‡ˆã§ãã‚‹çµæœã¯å¾—ã‚‰ã‚Œã¦ã„ãªã„ã¨æ€ã†ã€‚

```{r}
#| label: prep-lss
rules <-
  list(
    "äººã®æ­»" = c("æ­»å¾Œ", "æ­»ç—…", "æ­»æœŸ", "æ­»å› ", "æ­»éª¸", "ç”Ÿæ­»", "è‡ªæ®º", "æ®‰æ­»", "é “æ­»", "å¤‰æ­»", "äº¡", "æ­»ã¬", "äº¡ããªã‚‹", "æ®ºã™", "äº¡ãã™", "æ­»"),
    "æ‹æ„›" = c("æ„›", "æ‹", "æ„›ã™", "æ„›æƒ…", "æ‹äºº", "æ„›äºº", "æ‹æ„›", "å¤±æ‹", "æ‹ã—ã„"),
    "å‹æƒ…" = c("å‹é”", "å‹äºº", "æ—§å‹", "è¦ªå‹", "æœ‹å‹", "å‹", "ç´šå‹"),
    "ä¿¡ç”¨ãƒ»ä¸ä¿¡" = c("ä¿¡ç”¨", "ä¿¡ã˜ã‚‹", "ä¿¡ãšã‚‹", "ä¸ä¿¡", "ç–‘ã„", "ç–‘æƒ‘", "ç–‘å¿µ", "çŒœç–‘", "ç‹ç–‘", "ç–‘å•", "ç–‘ã„æ·±ã„", "ç–‘ã†", "ç–‘ã‚‹", "è­¦æˆ’"),
    "ç—…æ°—" = c("åŒ»è€…", "ç—…äºº", "ç—…å®¤", "ç—…é™¢", "ç—…ç—‡", "ç—…çŠ¶", "æŒç—…", "æ­»ç—…", "ä¸»æ²»åŒ»", "ç²¾ç¥ç—…", "ä»®ç—…", "ç—…æ°—", "çœ‹ç—…", "å¤§ç—…", "ç—…ã‚€", "ç—…")
  ) |>
    quanteda::dictionary()

# æ—¥æœ¬èªè©•ä¾¡æ¥µæ€§è¾æ›¸ï¼ˆç”¨è¨€ç·¨ï¼‰ https://www.cl.ecei.tohoku.ac.jp/Open_Resources-Japanese_Sentiment_Polarity_Dictionary.html
pn <-
  readr::read_tsv(
    "https://www.cl.ecei.tohoku.ac.jp/resources/sent_lex/wago.121808.pn",
    col_names = c("polarity", "word"),
    show_col_types = FALSE
  )

# æ¥µæ€§è¾æ›¸ã‚’ã‚‚ã¨ã«ç¨®èªã‚’ç”¨æ„ã™ã‚‹
seed <- pn |>
  dplyr::inner_join(
    dplyr::tbl(con, "tokens") |>
    dplyr::filter(pos == "å‹•è©") |>
    dplyr::select(token, pos, original) |>
    dplyr::distinct() |>
    dplyr::collect(),
    by = c("word" = "token")
  ) |>
  dplyr::mutate(
    polarity = dplyr::if_else(
      stringr::str_detect(polarity, "ãƒã‚¬"),
      "negative",
      "positive"
    ),
    token = dplyr::if_else(is.na(original), word, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::distinct(polarity, token) |>
  dplyr::reframe(dict = list(token), .by = polarity) |>
  tibble::deframe()

seed <- seed |>
  quanteda::dictionary() |>
  LSX::as.seedwords(upper = 2, lower = 1) # ã“ã“ã§ã¯positiveãŒ2ç•ªç›®, negativeãŒ1ç•ªç›®

toks <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    pos %in% c(
      "åè©", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::select(label, token) |>
  dplyr::collect() |>
  dplyr::reframe(dict = list(token), .by = label) |>
  tibble::deframe() |>
  quanteda::as.tokens()

term <-
  LSX::char_context(
    toks,
    pattern = rules$`ä¿¡ç”¨ãƒ»ä¸ä¿¡`,
    window = 10,
    valuetype = "regex",
    case_insensitive = FALSE,
    min_count = 2,
    p = 0.05
  ) |>
    toupper()
```

```{r}
#| label: fit-lss
#| cache: true
lss <-
  LSX::textmodel_lss(
    quanteda::dfm(toks),
    seeds = seed,
    terms = term,
    k = 20,
    include_data = TRUE,
    group_data = TRUE
  )
```

å˜èªã®æ¥µæ€§ã€‚

```{r}
#| label: plot-polarity-1
LSX::textplot_terms(lss)
```

æ–‡æ›¸ã®æ¥µæ€§ã€‚ã“ã“ã§ã¯æ–‡æ›¸ã®æ•°ãŒå°‘ãªã„ã®ã§ã“ã®ã‚ˆã†ã«ãƒ—ãƒ­ãƒƒãƒˆã—ã¦ã„ã‚‹ãŒã€å®Ÿéš›ã«ã¯ã‚‚ã£ã¨å¤§é‡ã®æ–‡æ›¸ã‚’åˆ†æã«ã‹ã‘ã‚‹ã¯ãšãªã®ã§ã€æ–‡æ›¸ã‚’æ¨ªè»¸ã«ã¨ã£ã¦`polarity`ã®æ›²ç·šã‚’æãå¯è¦–åŒ–ä¾‹ãŒãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã®vignetteã§ç´¹ä»‹ã•ã‚Œã¦ã„ã‚‹ã€‚

```{r}
#| label: plot-polarity-2
#| fig-height: 12
tibble::tibble(
  docs = factor(unique(tbl$label), levels = unique(tbl$label)),
  polarity = predict(lss)[as.character(docs)],
  section = tbl$section[match(docs, tbl$label)]
) |>
  dplyr::filter(!is.na(polarity)) |>
  ggplot(aes(x = docs, y = polarity, fill = section)) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  coord_flip() +
  theme_bw()
```

### åŠæ•™å¸«ã‚ã‚Šãƒˆãƒ”ãƒƒã‚¯ãƒ¢ãƒ‡ãƒ«ğŸ³

> ã‚ã¨ã§ã‚„ã‚‹

---

```{r}
#| label: cleanup
duckdb::dbDisconnect(con)
duckdb::duckdb_shutdown(drv)

sessioninfo::session_info(info = "packages")
```
