# æŠ½å‡ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼3

```{r}
#| label: setup
suppressPackageStartupMessages({
  library(ggplot2)
  library(duckdb)
})
drv <- duckdb::duckdb()
con <- duckdb::dbConnect(drv, dbdir = "tutorial_jp/kokoro.duckdb", read_only = TRUE)

tbl <-
  readxl::read_xls("tutorial_jp/kokoro.xls",
    col_names = c("text", "section", "chapter", "label"),
    skip = 1
  ) |>
  dplyr::mutate(
    doc_id = factor(dplyr::row_number()),
    dplyr::across(where(is.character), ~ audubon::strj_normalize(.))
  ) |>
  dplyr::filter(!gibasa::is_blank(text)) |>
  dplyr::relocate(doc_id, text, section, label, chapter)
```

## éšå±¤çš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åˆ†æï¼ˆA.5.9ï¼‰

### éé¡ä¼¼åº¦ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ğŸ³

Jaccardä¿‚æ•°ã‚’æŒ‡å®šã—ã¦éé¡ä¼¼åº¦ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’æãã¨ã€ãã‚‚ãã‚‚ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä½•ã‚‚è¦‹ãˆãªã‹ã£ãŸã€‚

```{r}
#| label: plot-heatmap
dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    pos %in% c(
      "åè©", #"åè©B", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(doc_id, token, n)

dat <- dfm |>
  quanteda::dfm_trim(min_termfreq = 30, termfreq_type = "rank") |>
  quanteda::dfm_weight(scheme = "boolean") |>
  proxyC::simil(margin = 2, method = "dice") |>
  rlang::as_function(~ 1 - .)()

factoextra::fviz_dist(as.dist(dat))
```

### éšå±¤çš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

```{r}
#| label: hclust
clusters <-
  as.dist(dat) |>
  hclust(method = "ward.D2")
```

### ã‚·ãƒ«ã‚¨ãƒƒãƒˆåˆ†æğŸ³

```{r}
#| label: plot-hclust-silhoutte-1
factoextra::fviz_nbclust(
  as.matrix(dat),
  FUNcluster = factoextra::hcut,
  k.max = ceiling(sqrt(nrow(dat)))
)
```

```{r}
#| label: plot-hclust-silhoutte-2
cluster::silhouette(cutree(clusters, k = 4), dist = dat) |>
  factoextra::fviz_silhouette(print.summary = FALSE) +
  theme_classic()
```

### ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ 

ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã«ã¤ã„ã¦ã¯ã€ä¼¼ãŸã‚ˆã†ãªè¡¨ç¾ã‚’æ‰‹è»½ã«å®Ÿç¾ã§ãã‚‹æ–¹æ³•ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã€‚ãƒ©ãƒ™ãƒ«ã®ä½ç½®ãŒå·¦å³åè»¢ã—ã¦ã„ã‚‹ãŒã€`factoextra::fviz_dend(horiz = TRUE)`ã¨ã™ã‚‹ã®ãŒç°¡å˜ã‹ã‚‚ã—ã‚Œãªã„ã€‚

```{r}
#| label: plot-hclust-factoextra
factoextra::fviz_dend(clusters, h = 1.0, horiz = TRUE, labels_track_height = 0.3)
```

### ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã¨æ£’ã‚°ãƒ©ãƒ•

KH Coderã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸæ„Ÿã˜ã€ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã¨ä¸€ç·’ã«èªã®å‡ºç¾å›æ•°ã‚’æã„ã¦ã„ã‚‹è¡¨ç¾ã¯ã€ã‚„ã‚„ç‹¬ç‰¹ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã€‚ã‚€ã—ã‚èªã®å‡ºç¾å›æ•°ã®ã»ã†ãŒä¸»ãªæƒ…å ±ã«ãªã£ã¦ã‚ˆã„ãªã‚‰ã€ãµã¤ã†ã®æ£’ã‚°ãƒ©ãƒ•ã®æ¨ªã«`ggh4x::scale_y_dendrogram()`ã§ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã‚’æãã“ã¨ãŒã§ãã‚‹ã€‚

```{r}
#| label: plot-hclust-ggplot2
dfm |>
  quanteda::dfm_trim(min_termfreq = 30, termfreq_type = "rank") |>
  quanteda::colSums() |>
  tibble::enframe() |>
  dplyr::mutate(
    clust = (clusters |> cutree(h = 1.0))[name]
  ) |>
  ggplot(aes(x = value, y = name, fill = factor(clust))) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_sqrt() +
  ggh4x::scale_y_dendrogram(hclust = clusters) +
  labs(x = "å‡ºç¾å›æ•°", y = element_blank()) +
  theme_bw()
```

## å…±èµ·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ï¼ˆA.5.10ï¼‰

> TODO: å…±èµ·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

## è‡ªå·±çµ„ç¹”åŒ–ãƒãƒƒãƒ—ï¼ˆA.5.11ï¼‰

### è‡ªå·±çµ„ç¹”åŒ–ãƒãƒƒãƒ—ï¼ˆSOMï¼‰

SOMã®å®Ÿè£…ã¨ã—ã¦ã¯ã€KH Coderã¯[som](https://cran.r-project.org/package=som)ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ã ãŒã€[kohonen](https://cran.r-project.org/package=kohonen)ã‚’ä½¿ã£ãŸã»ã†ãŒã‚ˆã„ã€‚è¡Œåˆ—ãŒéå¸¸ã«å¤§ãã„å ´åˆã«ã¯`kohonen::som(mode = "online")`ã¨ã—ã¦ã‚‚ã‚ˆã„ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ä¸€èˆ¬ã«ãƒãƒƒãƒå‹ã®ã»ã†ãŒåæŸãŒæ—©ãã€æ•°åã‚¹ãƒ†ãƒƒãƒ—ç¨‹åº¦å›ã›ã°ååˆ†ã§ã‚ã‚‹ã€‚

ä¸ãˆã‚‹å˜èªæ–‡æ›¸è¡Œåˆ—ã¯ã€ã“ã“ã§ã¯`tidytext::bind_tf_idf()`ã‚’ä½¿ã£ã¦TF-IDFã§é‡ã¿ã¥ã‘ã—ã€ä¸Šä½100èªã»ã©æŠ½å‡ºã™ã‚‹ã€‚

```{r}
#| label: fit-som
#| cache: true
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    pos %in% c(
      "åè©", #"åè©B", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::bind_tf_idf(token, doc_id, n) |>
  tidytext::cast_dfm(doc_id, token, tf_idf) |>
  quanteda::dfm_trim(
    min_termfreq = 100,
    termfreq_type = "rank"
  ) |>
  as.matrix() |>
  scale() |>
  t()

som_fit <-
  kohonen::som(
    dat,
    grid = kohonen::somgrid(16, 12, "hexagonal"),
    rlen = 50, # å­¦ç¿’å›æ•°
    alpha = c(0.05, 0.01),
    radius = 6,
    dist.fcts = "sumofsquares",
    mode = "pbatch",
    init = aweSOM::somInit(dat, 16, 12)
  )
```

```{r}
#| label: quality-som
aweSOM::somQuality(som_fit, dat)
```

### U-Matrix

U-matrixã¯ã€Œå„ãƒãƒ¼ãƒ‰ã®å‚ç…§ãƒ™ã‚¯ãƒˆãƒ«ãŒè¿‘å‚ãƒãƒ¼ãƒ‰ã¨ç•°ãªã‚‹åº¦åˆã„ã§è‰²ã¥ã‘ã™ã‚‹æ–¹æ³•ã€ï¼ˆ[è‡ªå·±çµ„ç¹”åŒ–ãƒãƒƒãƒ—å…¥é–€](https://www.brain.kyutech.ac.jp/~furukawa/data/SOMtext.pdf)ï¼‰ã€‚æš–è‰²ã®ç®‡æ‰€ã¯ãƒ‡ãƒ¼ã‚¿å¯†åº¦ãŒä½ã„ã€Œå±±é–“éƒ¨ã€ã§ã€å¯’è‰²ã®ç®‡æ‰€ã¯ãƒ‡ãƒ¼ã‚¿å¯†åº¦ãŒé«˜ã„ã€Œå¹³é‡éƒ¨ã€ã¿ãŸã„ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€å†™åƒã®å‹¾é…ãŒæ€¥å³»ã«ãªã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’å¢ƒã«ã—ã¦ã‚¯ãƒ©ã‚¹ã‚¿ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ã¨åˆ¤æ–­ã™ã‚‹ã¿ãŸã„ãªè¦‹æ–¹ã‚’ã™ã‚‹ã€‚

```{r}
#| label: plot-umatrix
aweSOM::aweSOMsmoothdist(som_fit)
```

```{r}
#| label: plot-umatrix-interactive
aweSOM::aweSOMplot(
  som_fit,
  data = dat,
  type = "UMatrix"
)
```

### ãƒ’ãƒƒãƒˆãƒãƒƒãƒ—ğŸ³

`clusters::pam()`ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦è‰²ã‚’ä»˜ã‘ã‚‹ã€‚ä¸€éƒ¨ã®ã€Œå±±é–“éƒ¨ã€ã‚„ã€Œç›†åœ°ã€ãŒã‚¯ãƒ©ã‚¹ã‚¿ã«ãªã£ã¦ã€å¾Œã¯ãã®ä»–ã®éƒ¨åˆ†ã¿ãŸã„ãªæ„Ÿã˜ã«åˆ†ã‹ã‚Œã‚‹ã‚ˆã†ã ãŒã€è§£é‡ˆã™ã‚‹ã®ã«ä¾¿åˆ©ãªæ„Ÿã˜ã§åˆ†ã‹ã‚Œã¦ã¯ãã‚Œãªã‹ã£ãŸã€‚

```{r}
#| label: cluster-som
clusters <- som_fit |>
  purrr::pluck("codes", 1) |> # å‚ç…§ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆcodebook vectorsï¼‰ã¯`codes`ã«ãƒªã‚¹ãƒˆã¨ã—ã¦æ ¼ç´ã•ã‚Œã¦ã„ã‚‹
  cluster::pam(k = 8)
```

ãƒ’ãƒƒãƒˆãƒãƒƒãƒ—ï¼ˆhitmap, proportion mapï¼‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå¯è¦–åŒ–ã®æ–¹æ³•ã€‚ãƒãƒ¼ãƒ‰ã®ä¸­ã®å…­è§’å½¢ã¯å„ãƒãƒ¼ãƒ‰ãŒä¿æŒã™ã‚‹å‚ç…§ãƒ™ã‚¯ãƒˆãƒ«ã®æ•°ï¼ˆæ¯”ç‡ï¼‰ã‚’è¡¨ã—ã¦ã„ã‚‹ã€‚ãƒãƒ¼ãƒ‰ã®èƒŒæ™¯è‰²ãŒä¸Šã®ã‚³ãƒ¼ãƒ‰ã§å¾—ãŸã‚¯ãƒ©ã‚¹ã‚¿ã«å¯¾å¿œã™ã‚‹ã€‚

```{r}
#| label: plot-hitmap
aweSOM::aweSOMplot(
  som_fit,
  data = dat,
  type = "Hitmap",
  superclass = clusters[["clustering"]]
)
```

---

```{r}
#| label: cleanup
duckdb::dbDisconnect(con)
duckdb::duckdb_shutdown(drv)

sessioninfo::session_info(info = "packages")
```
