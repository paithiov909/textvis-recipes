# æŠ½å‡ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼

```{r}
#| label: setup
suppressPackageStartupMessages({
  library(ggplot2)
  library(duckdb)
  library(arules)
  library(arulesViz)
  library(ca)
})
drv <- duckdb::duckdb()
con <- duckdb::dbConnect(drv, dbdir = "tutorial_jp/kokoro.duckdb", read_only = TRUE)

tbl <-
  readxl::read_xls("tutorial_jp/kokoro.xls",
    col_names = c("text", "section", "chapter", "label"),
    skip = 1
  ) |>
  dplyr::mutate(
    doc_id = factor(dplyr::row_number()),
    dplyr::across(where(is.character), ~ audubon::strj_normalize(.))
  ) |>
  dplyr::filter(!gibasa::is_blank(text)) |>
  dplyr::relocate(doc_id, text, section, label, chapter)
```

---

## æŠ½å‡ºèªãƒªã‚¹ãƒˆï¼ˆA.5.1ï¼‰

æ´»ç”¨èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã‚Œãã‚Œã®æ´»ç”¨ã®å‡ºç¾é »åº¦ã‚‚è¦‹ã‚Œã‚‹UIã«ã¤ã„ã¦ã¯ã€Rã ã¨ã©ã†ã™ã‚Œã°å®Ÿç¾ã§ãã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã€‚

```{r}
#| label: freq-list
dat <- dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    !pos %in% c("ãã®ä»–", "åè©B", "å‹•è©B", "å½¢å®¹è©B", "å‰¯è©B", "å¦å®šåŠ©å‹•è©", "å½¢å®¹è©ï¼ˆéè‡ªç«‹ï¼‰")
  ) |>
  dplyr::count(token, pos) |>
  dplyr::filter(n >= 100) |>
  dplyr::collect()

reactable::reactable(
  dat,
  filterable = TRUE,
  defaultColDef = reactable::colDef(
    cell = reactablefmtr::data_bars(dat)
  )
)
```

## å‡ºç¾å›æ•°ã®åˆ†å¸ƒï¼ˆA.5.2ï¼‰

### åº¦æ•°åˆ†å¸ƒè¡¨

```{r}
#| label: calc-tf
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    !pos %in% c("ãã®ä»–", "åè©B", "å‹•è©B", "å½¢å®¹è©B", "å‰¯è©B", "å¦å®šåŠ©å‹•è©", "å½¢å®¹è©ï¼ˆéè‡ªç«‹ï¼‰")
  ) |>
  dplyr::count(token, pos) |>
  dplyr::summarise(
    degree = sum(n, na.rm = TRUE),
    .by = n
  ) |>
  dplyr::mutate(
    prop = degree / sum(degree, na.rm = TRUE)
  ) |>
  dplyr::arrange(n) |>
  dplyr::compute() |>
  dplyr::mutate(
    cum_degree = cumsum(degree),
    cum_prop = cumsum(prop)
  ) |>
  dplyr::collect()

dat
```

### æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•

```{r}
#| label: plot-tf-dist
dat |>
  dplyr::filter(cum_prop < .8) |>
  ggplot(aes(x = n, y = degree)) +
  geom_line() +
  theme_bw() +
  labs(x = "å‡ºç¾å›æ•°", y = "åº¦æ•°")
```

## æ–‡æ›¸æ•°ã®åˆ†å¸ƒï¼ˆA.5.3ï¼‰

æ®µè½ï¼ˆ`doc_id`ï¼‰ã§ã¯ãªãã€ç« ãƒ©ãƒ™ãƒ«ï¼ˆ`label`ï¼‰ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã¦é›†è¨ˆã—ã¦ã„ã‚‹ã€‚`docfreq`ã«ã¤ã„ã¦ä¸Šã§ã‚„ã£ãŸã®ã¨åŒæ§˜ã«å‡¦ç†ã™ã‚Œã°åº¦æ•°åˆ†å¸ƒè¡¨ã«ã§ãã‚‹ã€‚

```{r}
#| label: calc-df
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    !pos %in% c("ãã®ä»–", "åè©B", "å‹•è©B", "å½¢å®¹è©B", "å‰¯è©B", "å¦å®šåŠ©å‹•è©", "å½¢å®¹è©ï¼ˆéè‡ªç«‹ï¼‰")
  ) |>
  dplyr::mutate(token = paste(token, pos, sep = "/")) |>
  dplyr::count(label, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(label, token, n) |>
  quanteda.textstats::textstat_frequency() |>
  dplyr::as_tibble()

dat
```

åº¦æ•°åˆ†å¸ƒã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèªã—ãŸã„ã ã‘ãªã‚‰ã€ã“ã®ã‹ãŸã¡ã‹ã‚‰ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’æã„ãŸã»ã†ãŒæ¥½ã€‚

```{r}
#| label: plot-df-hist
dat |>
  ggplot(aes(x = docfreq)) +
  geom_histogram(binwidth = 3) +
  scale_y_sqrt() +
  theme_bw() +
  labs(x = "æ–‡æ›¸æ•°", y = "åº¦æ•°")
```

## å‡ºç¾å›æ•°ãƒ»æ–‡æ›¸æ•°ã®ãƒ—ãƒ­ãƒƒãƒˆï¼ˆA.5.4ï¼‰

å›³ A.25ã®ã‚ˆã†ãªã‚°ãƒ©ãƒ•ã®ä¾‹ã€‚ggplot2ã§`graphics::identify`ã®ã‚ˆã†ãªã“ã¨ã‚’ã™ã‚‹ã‚„ã‚Šæ–¹ãŒã‚ã‹ã‚‰ãªã„ã®ã§ã€é©å½“ã«æ¡ä»¶ã‚’æŒ‡å®šã—ã¦gghighlightã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ã„ã‚‹ã€‚

```{r}
#| label: plot-tf-df
#| cache: true
dat |>
  ggplot(aes(x = frequency, y = docfreq)) +
  geom_jitter() +
  gghighlight::gghighlight(
    frequency > 100 & docfreq < 60
  ) +
  ggrepel::geom_text_repel(aes(label = feature)) +
  scale_x_log10() +
  theme_bw() +
  labs(x = "å‡ºç¾å›æ•°", y = "æ–‡æ›¸æ•°")
```

## KWICï¼ˆA.5.5ï¼‰

### ã‚³ãƒ³ã‚³ãƒ¼ãƒ€ãƒ³ã‚¹

ã‚³ãƒ³ã‚³ãƒ¼ãƒ€ãƒ³ã‚¹ã¯`quanteda::kwic()`ã§ç¢ºèªã§ãã‚‹ã€‚ã‚‚ã£ã¨ã‚‚ã€KH Coderã®æä¾›ã™ã‚‹ã‚³ãƒ³ã‚³ãƒ¼ãƒ€ãƒ³ã‚¹æ¤œç´¢ã‚„ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±è¨ˆã®ã»ã†ãŒæ˜ã‚‰ã‹ã«ãƒªãƒƒãƒãªã®ã¨ã€Rã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯æ—¥æœ¬èªã®é•·ã‚ã®æ–‡å­—åˆ—ã‚’è¡¨ç¤ºã™ã‚‹ã®ã«ã‚ã¾ã‚Šå‘ã„ã¦ã„ãªã„ã¨ã„ã†ã®ãŒã‚ã‚‹ã®ã§ã€ã“ã®ã‚ãŸã‚Šã®æ©Ÿèƒ½ãŒå¿…è¦ãªã‚‰KH Coderã‚’åˆ©ç”¨ã—ãŸã»ã†ãŒã‚ˆã„ã€‚

```{r}
#| label: kwic
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(section == "[1]ä¸Š_å…ˆç”Ÿã¨ç§") |>
  dplyr::select(label, token) |>
  dplyr::collect() |>
  dplyr::reframe(token = list(token), .by = label) |>
  tibble::deframe() |>
  quanteda::as.tokens() |>
  quanteda::tokens_select("[[:punct:]]", selection = "remove", valuetype = "regex", padding = FALSE) |>
  quanteda::tokens_select("^[\\p{Hiragana}]{1,2}$", selection = "remove", valuetype = "regex", padding = TRUE)

quanteda::kwic(dat, pattern = "^å‘[ã„ãã‘ã“]$", window = 5, valuetype = "regex")
```

ãªãŠã€ä¸Šã®ä¾‹ã§ã¯ã²ã‚‰ãŒãª1ï½2æ–‡å­—ã®èªã‚’paddingã—ã¤ã¤é™¤å¤–ã—ãŸã®ã§ã€ä¸€éƒ¨ã®åŠ©è©ãªã©ã¯è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ï¼ˆãã‚Œãã‚Œã®çª“ã®ãªã‹ã§ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦æ•°ãˆã‚‰ã‚Œã¦ã¯ã„ã‚‹ï¼‰ã€‚

### ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ãŸã¨ãˆã°ã€å‰å¾Œ5å€‹ã®windowå†…ã®ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆnodeã‚’å«ã‚ã¦11èªã®çª“ã¨ã„ã†ã“ã¨ï¼‰ã®åˆè¨ˆã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚ˆã†ã«ç¢ºèªã§ãã‚‹ã€‚

```{r}
#| label: collocation-1
dat |>
  quanteda::fcm(context = "window", window = 5) |>
  tidytext::tidy() |>
  dplyr::rename(node = document, term = term) |>
  dplyr::filter(node == "å‘ã„") |>
  dplyr::slice_max(count, n = 10)
```

ã€Œå·¦åˆè¨ˆã€ã‚„ã€Œå³åˆè¨ˆã€ã«ã¤ã„ã¦ã¯ã€ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ã«ã—ã¦ç¢ºèªã§ãã‚‹ã€‚paddingã—ãªã‘ã‚Œã°`tidyr::separate_wider_delim()`ã§å±•é–‹ã—ã¦ä½ç½®ã”ã¨ã«é›†è¨ˆã™ã‚‹ã“ã¨ã‚‚ã§ããã†ã€‚

```{r}
#| label: collocation-2
dat |>
  quanteda::kwic(pattern = "^å‘[ã„ãã‘ã“]$", window = 5, valuetype = "regex") |>
  dplyr::as_tibble() |>
  dplyr::select(docname, keyword, pre, post) |>
  tidyr::pivot_longer(
    c(pre, post),
    names_to = "window",
    values_to = "term",
    values_transform = ~ strsplit(., " ", fixed = TRUE)
  ) |>
  tidyr::unnest(term) |>
  dplyr::count(window, term, sort = TRUE)
```

## é–¢é€£èªæ¤œç´¢ï¼ˆA.5.6ï¼‰

### é–¢é€£èªã®ãƒªã‚¹ãƒˆ

ã€Œç¢ºç‡å·®ã€ã‚„ã€Œç¢ºç‡æ¯”ã€ã«ã¤ã„ã¦ã¯ã€ã„ã¡ãŠã†è¨ˆç®—ã¯ã§ããŸæ°—ãŒã™ã‚‹ãŒã€ã‚ã£ã¦ã„ã‚‹ã®ã‹ã‚ˆãã‚ã‹ã‚‰ãªã„ã€‚ã¾ãŸã€ã“ã®ã‚„ã‚Šæ–¹ã¯ãã‚Œãªã‚Šã®æ•°ã®å…±èµ·ã«ã¤ã„ã¦è¨ˆç®—ã‚’ã—ãªã‘ã‚Œã°ãªã‚‰ãšã€å…±èµ·è¡Œåˆ—ãŒå¤§ãããªã‚‹ã¨å¤§å¤‰ãã†ã€‚

```{r}
#| label: calc-co-measures
dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    section == "[1]ä¸Š_å…ˆç”Ÿã¨ç§",
    pos %in% c(
      "åè©", #"åè©B", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(doc_id, token, n) |>
  quanteda::dfm_weight(scheme = "boolean")

dat <- dfm |>
  quanteda::fcm() |>
  tidytext::tidy() |>
  dplyr::rename(target = document, co_occur = count) |>
  dplyr::reframe(
    term = term,
    target_occur = quanteda::colSums(dfm)[target],
    term_occur = quanteda::colSums(dfm)[term],
    co_occur = co_occur,
    .by = target
  ) |>
  dplyr::mutate(
    p_x = target_occur / quanteda::ndoc(dfm),
    p_y = term_occur / quanteda::ndoc(dfm),
    p_xy = (co_occur / quanteda::ndoc(dfm)) / p_x,
    differential = p_xy - p_y, # ç¢ºç‡å·®
    lift = p_xy / p_y, # ç¢ºç‡æ¯”ï¼ˆãƒªãƒ•ãƒˆï¼‰,
    jaccard = co_occur / (target_occur + term_occur - co_occur),
    dice = 2 * co_occur / (target_occur + term_occur)
  ) |>
  dplyr::select(target, term, differential, lift, jaccard, dice)

dat
```

### å…±èµ·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

ã€Œå…ˆç”Ÿ/åè©ã€ã¨é–¢é€£ã®å¼·ãã†ãªèªã®å…±èµ·ã‚’å›³ç¤ºã—ãŸä¾‹ã€‚

ã€Œå…ˆç”Ÿ/åè©ã€ã¨å…±èµ·ã—ã¦ã„ã‚‹èªã®ã†ã¡ã€å‡ºç¾å›æ•°ãŒä¸Šä½20ä½ä»¥å†…ã§ã‚ã‚‹èªãŒ`target`ã§ã‚ã‚‹å…±èµ·ã‚’æŠ½å‡ºã—ãŸã†ãˆã§ã€ãã‚Œã‚‰ã®ãªã‹ã‹ã‚‰Jaccardä¿‚æ•°ãŒå¤§ãã„é †ã«75å€‹ã ã‘æ®‹ã—ã¦ã„ã‚‹ã€‚ã€Œå…ˆç”Ÿ/åè©ã€ã¨ã„ã†èªãã®ã‚‚ã®ã¯å›³ã«å«ã‚ã¦ã„ãªã„ã€‚

```{r}
#| label: plot-co-measures
#| cache: true
dat |>
  dplyr::inner_join(
    dplyr::filter(dat, target == "å…ˆç”Ÿ/åè©") |> dplyr::select(term),
    by = dplyr::join_by(target == term)
  ) |>
  dplyr::filter(target %in% names(quanteda::topfeatures(dfm, 20))) |>
  dplyr::slice_max(jaccard, n = 75) |>
  tidygraph::as_tbl_graph(directed = FALSE) |>
  tidygraph::to_minimum_spanning_tree() |>
  purrr::pluck("mst") |>
  dplyr::mutate(
    community = factor(tidygraph::group_leading_eigen())
  ) |>
  ggraph::ggraph(layout = "fr") +
  ggraph::geom_edge_link(aes(width = sqrt(lift), alpha = jaccard)) +
  ggraph::geom_node_point(aes(colour = community), show.legend = FALSE) +
  ggraph::geom_node_text(aes(label = name, colour = community), repel = TRUE, show.legend = FALSE) +
  ggraph::theme_graph()
```

### ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æğŸ³

è‹±èªã ã¨ã“ã®ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã®åå‰ã¯ã€ŒWord Associationã€ã¨ãªã£ã¦ã„ã‚‹ã®ã§ã€ãµã¤ã†ã«ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³åˆ†æã™ã‚Œã°ã„ã„ã¨æ€ã£ãŸã€‚

arulesã®`transactions`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ã¤ãã‚‹ã«ã¯ã€quantedaã®`fcm`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰å¤‰æ›ã™ã‚Œã°ã‚ˆã„ï¼ˆarulesã‚’ã‚¢ã‚¿ãƒƒãƒã—ã¦ã„ã‚‹å¿…è¦ãŒã‚ã‚‹ï¼‰ã€‚

```{r}
#| label: create-transactions
library(arules)
library(arulesViz)

dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    pos %in% c(
      "åè©", #"åè©B", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(doc_id, token, n) |>
  quanteda::dfm_weight(scheme = "boolean") |>
  quanteda::fcm() |>
  as("nMatrix") |>
  as("transactions")
```

`arules::apriori()`ã§ã‚¢ã‚½ã‚·ã‚¨ãƒ¼ã‚·ãƒ§ãƒ³ãƒ«ãƒ¼ãƒ«ã‚’æŠ½å‡ºã™ã‚‹ã€‚

```{r}
#| label: apriori
#| cache: true
rules <-
  arules::apriori(
    dat,
    parameter = list(
      support = 0.075,
      confidence = 0.8,
      minlen = 2,
      maxlen = 2, # LHS+RHSã®é•·ã•ã€‚å¤‰ãˆãªã„ã»ã†ãŒã‚ˆã„
      maxtime = 5
    ),
    control = list(verbose = FALSE)
  )
```

ã“ã®å½¢å¼ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯`as(rules, "data.frame")`ã®ã‚ˆã†ã«ã—ã¦ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«å¤‰æ›ã§ãã‚‹ã€‚`tibble`ã«ã—ãŸã„å ´åˆã«ã¯æ¬¡ã®ã‚ˆã†ã«ã™ã‚Œã°ã‚ˆã„ã€‚

```{r}
#| label: glimpse-rules
as(rules, "data.frame") |>
  dplyr::mutate(across(where(is.numeric), ~ signif(., digits = 3))) |>
  tidyr::separate_wider_delim(rules, delim = " => ", names = c("lhs", "rhs")) |>
  dplyr::arrange(desc(lift))
```

### æ•£å¸ƒå›³ğŸ³

```{r}
#| label: plot-rules-scatter
plot(rules, engine = "html")
```

### ãƒãƒ«ãƒ¼ãƒ³ãƒ—ãƒ­ãƒƒãƒˆğŸ³

```{r}
#| label: plot-rules-grouped
plot(rules, method = "grouped", engine = "html")
```

### ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯å›³ğŸ³

```{r}
#| label: plot-rules-graph
plot(rules, method = "graph", engine = "html")
```

## å¯¾å¿œåˆ†æï¼ˆA.5.7ï¼‰

### ã‚³ãƒ¬ã‚¹ãƒãƒ³ãƒ‡ãƒ³ã‚¹åˆ†æ

æ®µè½ï¼ˆ`doc_id`ï¼‰å†…ã®é »åº¦ã§èªå½™ã‚’å‰Šã£ã¦ã‹ã‚‰éƒ¨ï¼ˆ`section`ï¼‰ã”ã¨ã«é›†è¨ˆã™ã‚‹ãŸã‚ã«ã€ã‚„ã‚„ã‚ã‚“ã©ã†ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã€‚

```{r}
#| label: create-dfm
dfm <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    pos %in% c(
      "åè©", "åè©B", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(doc_id, token, n) |>
  quanteda::dfm_trim(
    min_termfreq = 75,
    termfreq_type = "rank",
    min_docfreq = 30,
    docfreq_type = "count"
  )
```

ã“ã†ã—ã¦`doc_id`ã”ã¨ã«é›†è¨ˆã—ãŸ`dfm`ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’ä¸€åº¦`tidytext::tidy()`ã—ã¦3ã¤çµ„ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã«æˆ»ã—ã€`section`ã®ãƒ©ãƒ™ãƒ«ã‚’çµåˆã™ã‚‹ã€‚ã“ã®ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’ã‚‚ã†ä¸€åº¦`tidytext::cast_dfm()`ã§ç–è¡Œåˆ—ã«å¤‰æ›ã—ã¦ã€`quanteda.textmodels::textmodel_ca()`ã‚’ä½¿ã£ã¦å¯¾å¿œåˆ†æã«ã‹ã‘ã‚‹ã€‚

```{r}
#| label: fit-ca
#| cache: true
ca_fit <- dfm |>
  tidytext::tidy() |>
  dplyr::left_join(
    dplyr::select(tbl, doc_id, section),
    by = dplyr::join_by(document == doc_id)
  ) |>
  tidytext::cast_dfm(section, term, count) |>
  quanteda.textmodels::textmodel_ca(nd = 2, sparse = TRUE)
```

ã“ã®é–¢æ•°ã¯ç–è¡Œåˆ—ã«å¯¾ã—ã¦è¨ˆç®—ã‚’ãŠã“ãªãˆã‚‹ãŸã‚ã€æ¯”è¼ƒçš„å¤§ããªè¡Œåˆ—ã‚’æ¸¡ã—ã¦ã‚‚å¤§ä¸ˆå¤«ã€‚

### ãƒã‚¤ãƒ—ãƒ­ãƒƒãƒˆ

caãƒ‘ãƒƒã‚±ãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã‚‹ã¨`plot()`ã§ãƒã‚¤ãƒ—ãƒ­ãƒƒãƒˆã‚’æã‘ã‚‹ã€‚`factoextra::fviz_ca_biplot()`ã§ã‚‚æã‘ã‚‹ãŒã€è¦‹ãŸç›®ã¯`plot()`ã®ã¨ã‚ã¾ã‚Šå¤‰ã‚ã‚‰ãªã„ã€‚

```{r}
#| label: plot-ca-1
library(ca)
dat <- plot(ca_fit)
```

### ãƒã‚¤ãƒ—ãƒ­ãƒƒãƒˆï¼ˆãƒãƒ–ãƒ«ãƒ—ãƒ­ãƒƒãƒˆï¼‰

ggplot2ã§ãƒã‚¤ãƒ—ãƒ­ãƒƒãƒˆã‚’æç”»ã™ã‚‹ã«ã¯ã€ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ã«ã™ã‚‹ã€‚`ggrepel::geom_text_repel`ã§ãƒ©ãƒ™ãƒ«ã‚’å‡ºã™èªå½™ã®é¸æŠã®ä»•æ–¹ã¯ã‚‚ã†ã™ã“ã—å·¥å¤«ã—ãŸã»ã†ãŒã‚ˆã„ã‹ã‚‚ã—ã‚Œãªã„ã€‚

ãªãŠã€ã“ã®ã‚³ãƒ¼ãƒ‰ã¯[Correspondence Analysis visualization using ggplot | R-bloggers](https://www.r-bloggers.com/2019/08/correspondence-analysis-visualization-using-ggplot/)ã‚’å‚è€ƒã«ã—ãŸã€‚

```{r}
#| label: plot-ca-2
tf <- dfm |>
  tidytext::tidy() |>
  dplyr::left_join(
    dplyr::select(tbl, doc_id, section),
    by = dplyr::join_by(document == doc_id)
  ) |>
  dplyr::summarise(tf = sum(count), .by = term) |>
  dplyr::pull(tf, term)

# modified from https://www.r-bloggers.com/2019/08/correspondence-analysis-visualization-using-ggplot/
make_ca_plot_df <- function(ca.plot.obj, row.lab = "Rows", col.lab = "Columns") {
  tibble::tibble(
    Label = c(
      rownames(ca.plot.obj$rows),
      rownames(ca.plot.obj$cols)
    ),
    Dim1 = c(
      ca.plot.obj$rows[, 1],
      ca.plot.obj$cols[, 1]
    ),
    Dim2 = c(
      ca.plot.obj$rows[, 2],
      ca.plot.obj$cols[, 2]
    ),
    Variable = c(
      rep(row.lab, nrow(ca.plot.obj$rows)),
      rep(col.lab, nrow(ca.plot.obj$cols))
    )
  )
}
dat <- dat |>
  make_ca_plot_df(row.lab = "Construction", col.lab = "Medium") |>
  dplyr::mutate(
    Size = dplyr::if_else(Variable == "Construction", mean(tf), tf[Label])
  )
# éASCIIæ–‡å­—ã®ãƒ©ãƒ™ãƒ«ã«å¯¾ã—ã¦warningã‚’å‡ºã•ãªã„ã‚ˆã†ã«ã™ã‚‹
suppressWarnings({
  ca_sum <- summary(ca_fit)
  dim_var_percs <- ca_sum$scree[, "values2"]
})

dat |>
  ggplot(aes(x = Dim1, y = Dim2, col = Variable, label = Label)) +
  geom_vline(xintercept = 0, lty = "dashed", alpha = .5) +
  geom_hline(yintercept = 0, lty = "dashed", alpha = .5) +
  geom_jitter(aes(size = Size), alpha = .3, show.legend = FALSE) +
  ggrepel::geom_label_repel(
    data = \(x) dplyr::filter(x, Variable == "Construction"),
    show.legend = FALSE
  ) +
  ggrepel::geom_text_repel(
    data = \(x) dplyr::filter(x, Variable == "Medium", sqrt(Dim1^2 + Dim2^2) > 0.25),
    show.legend = FALSE
  ) +
  scale_x_continuous(
    limits = range(dat$Dim1) +
      c(diff(range(dat$Dim1)) * -0.2, diff(range(dat$Dim1)) * 0.2)) +
  scale_y_continuous(
    limits = range(dat$Dim2) +
      c(diff(range(dat$Dim2)) * -0.2, diff(range(dat$Dim2)) * 0.2)) +
  scale_size_area(max_size = 16) +
  labs(
    x = paste0("Dimension 1 (", signif(dim_var_percs[1], 3), "%)"),
    y = paste0("Dimension 2 (", signif(dim_var_percs[2], 3), "%)")
  ) +
  theme_classic()
```

## å¤šæ¬¡å…ƒå°ºåº¦æ§‹æˆæ³•ï¼ˆA.5.8ï¼‰

### MDSãƒ»ãƒãƒ–ãƒ«ãƒ—ãƒ­ãƒƒãƒˆ

`MASS::isoMDS`ã‚ˆã‚Š`MASS::sammon`ã®ã»ã†ãŒãŸã¶ã‚“è¦‹ã‚„ã™ã„ã€‚

```{r}
#| label: mds-2d
#| cache: true
simil <- dfm |>
  quanteda::dfm_weight(scheme = "boolean") |>
  proxyC::simil(margin = 2, method = "jaccard")

dat <- MASS::sammon(1 - simil, k = 2) |>
  purrr::pluck("points")
```

```{r}
#| label: plot-mds-2d
dat <- dat |>
  as.data.frame() |>
  tibble::rownames_to_column("label") |>
  dplyr::rename(Dim1 = V1, Dim2 = V2) |>
  dplyr::mutate(
    size = tf[label],
    clust = (hclust(
      proxyC::dist(dat, method = "euclidean") |> as.dist(),
      method = "ward.D2"
    ) |> cutree(k = 6))[label]
  )

dat |>
  ggplot(aes(x = Dim1, y = Dim2, label = label, col = factor(clust))) +
  geom_point(aes(size = size), alpha = .3, show.legend = FALSE) +
  ggrepel::geom_text_repel(show.legend = FALSE) +
  scale_size_area(max_size = 16) +
  theme_classic()
```

### MDSãƒ»3æ¬¡å…ƒãƒ—ãƒ­ãƒƒãƒˆ

rglã§ã¯ãªãplotlyã§è©¦ã—ã¦ã¿ãŸãŒã€ã¨ãã«è¦‹ã‚„ã™ã„ã¨ã„ã†ã“ã¨ã¯ãªã‹ã£ãŸã‹ã‚‚ã—ã‚Œãªã„ã€‚

```{r}
#| label: mds-3d
#| cache: true
dat <- MASS::sammon(1 - simil, k = 3) |>
  purrr::pluck("points") |>
  as.data.frame() |>
  tibble::rownames_to_column("label") |>
  dplyr::rename(Dim1 = V1, Dim2 = V2, Dim3 = V3) |>
  dplyr::mutate(term_freq = tf[label])
```

```{r}
#| label: plot-mds-3d
dat |>
  plotly::plot_ly(x = ~Dim1, y = ~Dim2, z = ~Dim3, text = ~label, color = ~term_freq) |>
  plotly::add_markers(opacity = .5)
```

## éšå±¤çš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼åˆ†æï¼ˆA.5.9ï¼‰

### éé¡ä¼¼åº¦ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ğŸ³

Jaccardä¿‚æ•°ã‚’æŒ‡å®šã—ã¦éé¡ä¼¼åº¦ã®ãƒ’ãƒ¼ãƒˆãƒãƒƒãƒ—ã‚’æãã¨ã€ãã‚‚ãã‚‚ãƒ‘ã‚¿ãƒ¼ãƒ³ãŒä½•ã‚‚è¦‹ãˆãªã‹ã£ãŸã€‚

```{r}
#| label: plot-heatmap
dat <- dfm |>
  quanteda::dfm_trim(min_termfreq = 30, termfreq_type = "rank") |>
  quanteda::dfm_weight(scheme = "boolean") |>
  proxyC::simil(margin = 2, method = "dice") |>
  rlang::as_function(~ 1 - .)()

factoextra::fviz_dist(as.dist(dat))
```

### éšå±¤çš„ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°

```{r}
#| label: hclust
clusters <-
  as.dist(dat) |>
  hclust(method = "ward.D2")
```

### ã‚·ãƒ«ã‚¨ãƒƒãƒˆåˆ†æğŸ³

```{r}
#| label: plot-hclust-silhoutte-1
factoextra::fviz_nbclust(
  as.matrix(dat),
  FUNcluster = factoextra::hcut,
  k.max = ceiling(sqrt(nrow(dat)))
)
```

```{r}
#| label: plot-hclust-silhoutte-2
cluster::silhouette(cutree(clusters, k = 4), dist = dat) |>
  factoextra::fviz_silhouette(print.summary = FALSE) +
  theme_classic()
```

### ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ 

ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã«ã¤ã„ã¦ã¯ã€ä¼¼ãŸã‚ˆã†ãªè¡¨ç¾ã‚’æ‰‹è»½ã«å®Ÿç¾ã§ãã‚‹æ–¹æ³•ãŒè¦‹ã¤ã‘ã‚‰ã‚Œãªã„ã€‚ãƒ©ãƒ™ãƒ«ã®ä½ç½®ãŒå·¦å³åè»¢ã—ã¦ã„ã‚‹ãŒã€`factoextra::fviz_dend(horiz = TRUE)`ã¨ã™ã‚‹ã®ãŒç°¡å˜ã‹ã‚‚ã—ã‚Œãªã„ã€‚

```{r}
#| label: plot-hclust-factoextra
factoextra::fviz_dend(clusters, h = 1.0, horiz = TRUE, labels_track_height = 0.3)
```

### ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã¨æ£’ã‚°ãƒ©ãƒ•

KH Coderã®ã‚½ãƒ¼ã‚¹ã‚³ãƒ¼ãƒ‰ã‚’è¦‹ãŸæ„Ÿã˜ã€ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã¨ä¸€ç·’ã«èªã®å‡ºç¾å›æ•°ã‚’æã„ã¦ã„ã‚‹è¡¨ç¾ã¯ã€ã‚„ã‚„ç‹¬ç‰¹ãªã“ã¨ã‚’ã—ã¦ã„ã‚‹ã€‚ã‚€ã—ã‚èªã®å‡ºç¾å›æ•°ã®ã»ã†ãŒä¸»ãªæƒ…å ±ã«ãªã£ã¦ã‚ˆã„ãªã‚‰ã€ãµã¤ã†ã®æ£’ã‚°ãƒ©ãƒ•ã®æ¨ªã«`ggh4x::scale_y_dendrogram()`ã§ãƒ‡ãƒ³ãƒ‰ãƒ­ã‚°ãƒ©ãƒ ã‚’æãã“ã¨ãŒã§ãã‚‹ã€‚

```{r}
#| label: plot-hclust-ggplot2
dfm |>
  quanteda::dfm_trim(min_termfreq = 30, termfreq_type = "rank") |>
  quanteda::colSums() |>
  tibble::enframe() |>
  dplyr::mutate(
    clust = (clusters |> cutree(h = 1.0))[name]
  ) |>
  ggplot(aes(x = value, y = name, fill = factor(clust))) +
  geom_bar(stat = "identity", show.legend = FALSE) +
  scale_x_sqrt() +
  ggh4x::scale_y_dendrogram(hclust = clusters) +
  labs(x = "å‡ºç¾å›æ•°", y = element_blank()) +
  theme_bw()
```

## å…±èµ·ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯

## è‡ªå·±çµ„ç¹”åŒ–ãƒãƒƒãƒ—ï¼ˆA.5.10ï¼‰

### è‡ªå·±çµ„ç¹”åŒ–ãƒãƒƒãƒ—ï¼ˆSOMï¼‰

SOMã®å®Ÿè£…ã¨ã—ã¦ã¯ã€KH Coderã¯[som](https://cran.r-project.org/package=som)ã‚’ä½¿ã£ã¦ã„ã‚‹ã‚ˆã†ã ãŒã€[kohonen](https://cran.r-project.org/package=kohonen)ã‚’ä½¿ã£ãŸã»ã†ãŒã‚ˆã„ã€‚è¡Œåˆ—ãŒéå¸¸ã«å¤§ãã„å ´åˆã«ã¯`kohonen::som(mode = "online")`ã¨ã—ã¦ã‚‚ã‚ˆã„ã®ã‹ã‚‚ã—ã‚Œãªã„ãŒã€ä¸€èˆ¬ã«ãƒãƒƒãƒå‹ã®ã»ã†ãŒåæŸãŒæ—©ãã€æ•°åã‚¹ãƒ†ãƒƒãƒ—ç¨‹åº¦å›ã›ã°ååˆ†ã§ã‚ã‚‹ã€‚

ä¸ãˆã‚‹å˜èªæ–‡æ›¸è¡Œåˆ—ã¯ã€ã“ã“ã§ã¯`tidytext::bind_tf_idf()`ã‚’ä½¿ã£ã¦TF-IDFã§é‡ã¿ã¥ã‘ã—ã€ä¸Šä½100èªã»ã©æŠ½å‡ºã™ã‚‹ã€‚

```{r}
#| label: fit-som
#| cache: true
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    pos %in% c(
      "åè©", #"åè©B", "åè©C",
      "åœ°å", "äººå", "çµ„ç¹”å", "å›ºæœ‰åè©",
      "å‹•è©", "æœªçŸ¥èª", "ã‚¿ã‚°"
    )
  ) |>
  dplyr::mutate(
    token = dplyr::if_else(is.na(original), token, original),
    token = paste(token, pos, sep = "/")
  ) |>
  dplyr::count(doc_id, token) |>
  dplyr::collect() |>
  tidytext::bind_tf_idf(token, doc_id, n) |>
  tidytext::cast_dfm(doc_id, token, tf_idf) |>
  quanteda::dfm_trim(
    min_termfreq = 100,
    termfreq_type = "rank"
  ) |>
  as.matrix() |>
  scale() |>
  t()

som_fit <-
  kohonen::som(
    dat,
    grid = kohonen::somgrid(16, 12, "hexagonal"),
    rlen = 50, # å­¦ç¿’å›æ•°
    alpha = c(0.05, 0.01),
    radius = 6,
    dist.fcts = "sumofsquares",
    mode = "pbatch",
    init = aweSOM::somInit(dat, 16, 12)
  )
```

```{r}
#| label: quality-som
aweSOM::somQuality(som_fit, dat)
```

### U-Matrix

U-matrixã¯ã€Œå„ãƒãƒ¼ãƒ‰ã®å‚ç…§ãƒ™ã‚¯ãƒˆãƒ«ãŒè¿‘å‚ãƒãƒ¼ãƒ‰ã¨ç•°ãªã‚‹åº¦åˆã„ã§è‰²ã¥ã‘ã™ã‚‹æ–¹æ³•ã€ï¼ˆ[è‡ªå·±çµ„ç¹”åŒ–ãƒãƒƒãƒ—å…¥é–€](https://www.brain.kyutech.ac.jp/~furukawa/data/SOMtext.pdf)ï¼‰ã€‚æš–è‰²ã®ç®‡æ‰€ã¯ãƒ‡ãƒ¼ã‚¿å¯†åº¦ãŒä½ã„ã€Œå±±é–“éƒ¨ã€ã§ã€å¯’è‰²ã®ç®‡æ‰€ã¯ãƒ‡ãƒ¼ã‚¿å¯†åº¦ãŒé«˜ã„ã€Œå¹³é‡éƒ¨ã€ã¿ãŸã„ãªã‚¤ãƒ¡ãƒ¼ã‚¸ã€å†™åƒã®å‹¾é…ãŒæ€¥å³»ã«ãªã£ã¦ã„ã‚‹ç®‡æ‰€ã‚’å¢ƒã«ã—ã¦ã‚¯ãƒ©ã‚¹ã‚¿ãŒåˆ†ã‹ã‚Œã¦ã„ã‚‹ã¨åˆ¤æ–­ã™ã‚‹ã¿ãŸã„ãªè¦‹æ–¹ã‚’ã™ã‚‹ã€‚

```{r}
#| label: plot-umatrix
aweSOM::aweSOMsmoothdist(som_fit)
```

```{r}
#| label: plot-umatrix-interactive
aweSOM::aweSOMplot(
  som_fit,
  data = dat,
  type = "UMatrix"
)
```

### ãƒ’ãƒƒãƒˆãƒãƒƒãƒ—ğŸ³

`clusters::pam()`ã§ã‚¯ãƒ©ã‚¹ã‚¿ãƒªãƒ³ã‚°ã—ã¦è‰²ã‚’ä»˜ã‘ã‚‹ã€‚ã€Œå±±é–“éƒ¨ã€ã«å›²ã¾ã‚ŒãŸä¸€éƒ¨ã®ã€Œç›†åœ°ã€ãŒã‚¯ãƒ©ã‚¹ã‚¿ã«ãªã£ã¦ã€å¾Œã¯ãã®ä»–ã®éƒ¨åˆ†ã¿ãŸã„ãªæ„Ÿã˜ã«åˆ†ã‹ã‚Œã‚‹ã‚ˆã†ã ãŒã€è§£é‡ˆã™ã‚‹ã®ã«ä¾¿åˆ©ãªæ„Ÿã˜ã§åˆ†ã‹ã‚Œã¦ã¯ãã‚Œãªã‹ã£ãŸã€‚

```{r}
#| label: cluster-som
clusters <- som_fit |>
  purrr::pluck("codes", 1) |> # å‚ç…§ãƒ™ã‚¯ãƒˆãƒ«ï¼ˆcodebook vectorsï¼‰ã¯`codes`ã«ãƒªã‚¹ãƒˆã¨ã—ã¦æ ¼ç´ã•ã‚Œã¦ã„ã‚‹
  cluster::pam(k = 8)
```

ãƒ’ãƒƒãƒˆãƒãƒƒãƒ—ï¼ˆhitmap, proportion mapï¼‰ã¯ä»¥ä¸‹ã®ã‚ˆã†ãªå¯è¦–åŒ–ã®æ–¹æ³•ã€‚ãƒãƒ¼ãƒ‰ã®ä¸­ã®å…­è§’å½¢ã¯å„ãƒãƒ¼ãƒ‰ãŒä¿æŒã™ã‚‹å‚ç…§ãƒ™ã‚¯ãƒˆãƒ«ã®æ•°ï¼ˆæ¯”ç‡ï¼‰ã‚’è¡¨ã—ã¦ã„ã‚‹ã€‚ãƒãƒ¼ãƒ‰ã®èƒŒæ™¯è‰²ãŒä¸Šã®ã‚³ãƒ¼ãƒ‰ã§å¾—ãŸã‚¯ãƒ©ã‚¹ã‚¿ã«å¯¾å¿œã™ã‚‹ã€‚

```{r}
#| label: plot-hitmap
aweSOM::aweSOMplot(
  som_fit,
  data = dat,
  type = "Hitmap",
  superclass = clusters[["clustering"]]
)
```
---

```{r}
#| label: cleanup
duckdb::dbDisconnect(con)
duckdb::duckdb_shutdown(drv)

sessioninfo::session_info(info = "packages")
```
