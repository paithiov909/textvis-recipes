# æŠ½å‡ºèªãƒ¡ãƒ‹ãƒ¥ãƒ¼1

```{r}
#| label: setup
suppressPackageStartupMessages({
  library(ggplot2)
  library(duckdb)
})
drv <- duckdb::duckdb()
con <- duckdb::dbConnect(drv, dbdir = "tutorial_jp/kokoro.duckdb", read_only = TRUE)

tbl <-
  readxl::read_xls("tutorial_jp/kokoro.xls",
    col_names = c("text", "section", "chapter", "label"),
    skip = 1
  ) |>
  dplyr::mutate(
    doc_id = factor(dplyr::row_number()),
    dplyr::across(where(is.character), ~ audubon::strj_normalize(.))
  ) |>
  dplyr::filter(!gibasa::is_blank(text)) |>
  dplyr::relocate(doc_id, text, section, label, chapter)
```

---

## æŠ½å‡ºèªãƒªã‚¹ãƒˆï¼ˆA.5.1ï¼‰

æ´»ç”¨èªã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ãã‚Œãã‚Œã®æ´»ç”¨ã®å‡ºç¾é »åº¦ã‚‚è¦‹ã‚Œã‚‹UIã«ã¤ã„ã¦ã¯ã€Rã ã¨ã©ã†ã™ã‚Œã°å®Ÿç¾ã§ãã‚‹ã‹ã‚ã‹ã‚‰ãªã„ã€‚

```{r}
#| label: freq-list
dat <- dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    !pos %in% c("ãã®ä»–", "åè©B", "å‹•è©B", "å½¢å®¹è©B", "å‰¯è©B", "å¦å®šåŠ©å‹•è©", "å½¢å®¹è©ï¼ˆéè‡ªç«‹ï¼‰")
  ) |>
  dplyr::count(token, pos) |>
  dplyr::filter(n >= 100) |>
  dplyr::collect()

reactable::reactable(
  dat,
  filterable = TRUE,
  defaultColDef = reactable::colDef(
    cell = reactablefmtr::data_bars(dat)
  )
)
```

## å‡ºç¾å›æ•°ã®åˆ†å¸ƒï¼ˆA.5.2ï¼‰

### åº¦æ•°åˆ†å¸ƒè¡¨

```{r}
#| label: calc-tf
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(
    !pos %in% c("ãã®ä»–", "åè©B", "å‹•è©B", "å½¢å®¹è©B", "å‰¯è©B", "å¦å®šåŠ©å‹•è©", "å½¢å®¹è©ï¼ˆéè‡ªç«‹ï¼‰")
  ) |>
  dplyr::count(token, pos) |>
  dplyr::summarise(
    degree = sum(n, na.rm = TRUE),
    .by = n
  ) |>
  dplyr::mutate(
    prop = degree / sum(degree, na.rm = TRUE)
  ) |>
  dplyr::arrange(n) |>
  dplyr::compute() |>
  dplyr::mutate(
    cum_degree = cumsum(degree),
    cum_prop = cumsum(prop)
  ) |>
  dplyr::collect()

dat
```

### æŠ˜ã‚Œç·šã‚°ãƒ©ãƒ•

```{r}
#| label: plot-tf-dist
dat |>
  dplyr::filter(cum_prop < .8) |>
  ggplot(aes(x = n, y = degree)) +
  geom_line() +
  theme_bw() +
  labs(x = "å‡ºç¾å›æ•°", y = "åº¦æ•°")
```

## æ–‡æ›¸æ•°ã®åˆ†å¸ƒï¼ˆA.5.3ï¼‰

### ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ğŸ³

æ®µè½ï¼ˆ`doc_id`ï¼‰ã§ã¯ãªãã€ç« ãƒ©ãƒ™ãƒ«ï¼ˆ`label`ï¼‰ã§ã‚°ãƒ«ãƒ¼ãƒ”ãƒ³ã‚°ã—ã¦é›†è¨ˆã—ã¦ã„ã‚‹ã€‚`docfreq`ã«ã¤ã„ã¦ä¸Šã§ã‚„ã£ãŸã®ã¨åŒæ§˜ã«å‡¦ç†ã™ã‚Œã°åº¦æ•°åˆ†å¸ƒè¡¨ã«ã§ãã‚‹ã€‚

```{r}
#| label: calc-df
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::mutate(token = paste(token, pos, sep = "/")) |>
  dplyr::count(label, token) |>
  dplyr::collect() |>
  tidytext::cast_dfm(label, token, n) |>
  quanteda.textstats::textstat_frequency() |>
  dplyr::as_tibble()

dat
```

åº¦æ•°åˆ†å¸ƒã‚’ã‚°ãƒ©ãƒ•ã§ç¢ºèªã—ãŸã„ã ã‘ãªã‚‰ã€ã“ã®ã‹ãŸã¡ã‹ã‚‰ãƒ’ã‚¹ãƒˆã‚°ãƒ©ãƒ ã‚’æã„ãŸã»ã†ãŒæ¥½ã€‚

```{r}
#| label: plot-df-hist
dat |>
  ggplot(aes(x = docfreq)) +
  geom_histogram(binwidth = 3) +
  scale_y_sqrt() +
  theme_bw() +
  labs(x = "æ–‡æ›¸æ•°", y = "åº¦æ•°")
```

### Zip's lawğŸ³

ã‚ˆãè¦‹ã‹ã‘ã‚‹ã‚°ãƒ©ãƒ•ã€‚[è¨€èªå‡¦ç†100æœ¬ãƒãƒƒã‚¯ 2020](https://nlp100.github.io/ja/ch04.html#39-zipf%E3%81%AE%E6%B3%95%E5%89%87)ã®39ã¯ã“ã‚Œã«ã‚ãŸã‚‹ã€‚

```{r}
#| label: plot-zipf
dat |>
  ggplot(aes(x = rank, y = frequency)) +
  geom_line() +
  geom_smooth(method = lm, formula = y ~ x, se = FALSE) +
  scale_x_log10() +
  scale_y_log10() +
  theme_bw()
```

## å‡ºç¾å›æ•°ãƒ»æ–‡æ›¸æ•°ã®ãƒ—ãƒ­ãƒƒãƒˆï¼ˆA.5.4ï¼‰

å›³ A.25ã®ã‚ˆã†ãªã‚°ãƒ©ãƒ•ã®ä¾‹ã€‚ggplot2ã§`graphics::identify`ã®ã‚ˆã†ãªã“ã¨ã‚’ã™ã‚‹ã‚„ã‚Šæ–¹ãŒã‚ã‹ã‚‰ãªã„ã®ã§ã€é©å½“ã«æ¡ä»¶ã‚’æŒ‡å®šã—ã¦gghighlightã§ãƒã‚¤ãƒ©ã‚¤ãƒˆã—ã¦ã„ã‚‹ã€‚

```{r}
#| label: plot-tf-df
#| cache: true
dat |>
  ggplot(aes(x = frequency, y = docfreq)) +
  geom_jitter() +
  gghighlight::gghighlight(
    frequency > 100 & docfreq < 60
  ) +
  ggrepel::geom_text_repel(aes(label = feature)) +
  scale_x_log10() +
  theme_bw() +
  labs(x = "å‡ºç¾å›æ•°", y = "æ–‡æ›¸æ•°")
```

## KWICï¼ˆA.5.5ï¼‰

### ã‚³ãƒ³ã‚³ãƒ¼ãƒ€ãƒ³ã‚¹

ã‚³ãƒ³ã‚³ãƒ¼ãƒ€ãƒ³ã‚¹ã¯`quanteda::kwic()`ã§ç¢ºèªã§ãã‚‹ã€‚ã‚‚ã£ã¨ã‚‚ã€KH Coderã®æä¾›ã™ã‚‹ã‚³ãƒ³ã‚³ãƒ¼ãƒ€ãƒ³ã‚¹æ¤œç´¢ã‚„ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³çµ±è¨ˆã®ã»ã†ãŒæ˜ã‚‰ã‹ã«ãƒªãƒƒãƒãªã®ã¨ã€Rã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã¯æ—¥æœ¬èªã®é•·ã‚ã®æ–‡å­—åˆ—ã‚’è¡¨ç¤ºã™ã‚‹ã®ã«ã‚ã¾ã‚Šå‘ã„ã¦ã„ãªã„ã¨ã„ã†ã®ãŒã‚ã‚‹ã®ã§ã€ã“ã®ã‚ãŸã‚Šã®æ©Ÿèƒ½ãŒå¿…è¦ãªã‚‰KH Coderã‚’åˆ©ç”¨ã—ãŸã»ã†ãŒã‚ˆã„ã€‚

```{r}
#| label: kwic
dat <-
  dplyr::tbl(con, "tokens") |>
  dplyr::filter(section == "[1]ä¸Š_å…ˆç”Ÿã¨ç§") |>
  dplyr::select(label, token) |>
  dplyr::collect() |>
  dplyr::reframe(token = list(token), .by = label) |>
  tibble::deframe() |>
  quanteda::as.tokens() |>
  quanteda::tokens_select("[[:punct:]]", selection = "remove", valuetype = "regex", padding = FALSE) |>
  quanteda::tokens_select("^[\\p{Hiragana}]{1,2}$", selection = "remove", valuetype = "regex", padding = TRUE)

quanteda::kwic(dat, pattern = "^å‘[ã„ãã‘ã“]$", window = 5, valuetype = "regex")
```

ãªãŠã€ä¸Šã®ä¾‹ã§ã¯ã²ã‚‰ãŒãª1ï½2æ–‡å­—ã®èªã‚’paddingã—ã¤ã¤é™¤å¤–ã—ãŸã®ã§ã€ä¸€éƒ¨ã®åŠ©è©ãªã©ã¯è¡¨ç¤ºã•ã‚Œã¦ã„ãªã„ï¼ˆãã‚Œãã‚Œã®çª“ã®ãªã‹ã§ãƒˆãƒ¼ã‚¯ãƒ³ã¨ã—ã¦æ•°ãˆã‚‰ã‚Œã¦ã¯ã„ã‚‹ï¼‰ã€‚

### ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³

ãŸã¨ãˆã°ã€å‰å¾Œ5å€‹ã®windowå†…ã®ã‚³ãƒ­ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ï¼ˆnodeã‚’å«ã‚ã¦11èªã®çª“ã¨ã„ã†ã“ã¨ï¼‰ã®åˆè¨ˆã«ã¤ã„ã¦ã¯æ¬¡ã®ã‚ˆã†ã«ç¢ºèªã§ãã‚‹ã€‚

```{r}
#| label: collocation-1
dat |>
  quanteda::fcm(context = "window", window = 5) |>
  tidytext::tidy() |>
  dplyr::rename(node = document, term = term) |>
  dplyr::filter(node == "å‘ã„") |>
  dplyr::slice_max(count, n = 10)
```

ã€Œå·¦åˆè¨ˆã€ã‚„ã€Œå³åˆè¨ˆã€ã«ã¤ã„ã¦ã¯ã€ãŸã¨ãˆã°æ¬¡ã®ã‚ˆã†ã«ã—ã¦ç¢ºèªã§ãã‚‹ã€‚paddingã—ãªã‘ã‚Œã°`tidyr::separate_wider_delim()`ã§å±•é–‹ã—ã¦ä½ç½®ã”ã¨ã«é›†è¨ˆã™ã‚‹ã“ã¨ã‚‚ã§ããã†ã€‚

```{r}
#| label: collocation-2
dat |>
  quanteda::kwic(pattern = "^å‘[ã„ãã‘ã“]$", window = 5, valuetype = "regex") |>
  dplyr::as_tibble() |>
  dplyr::select(docname, keyword, pre, post) |>
  tidyr::pivot_longer(
    c(pre, post),
    names_to = "window",
    values_to = "term",
    values_transform = ~ strsplit(., " ", fixed = TRUE)
  ) |>
  tidyr::unnest(term) |>
  dplyr::count(window, term, sort = TRUE)
```

---

```{r}
#| label: cleanup
duckdb::dbDisconnect(con)
duckdb::duckdb_shutdown(drv)

sessioninfo::session_info(info = "packages")
```
